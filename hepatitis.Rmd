---
title: "Hepatitis"
output: html_notebook
---

Variable names and data were in a separate file. Start by assigning names to variables.

```{r}
hepatitis_raw <- read.csv("C:/Users/kelse/Documents/Year_2/Rotations/Colubri/Hepatitis_data/hepatitis.csv", header = FALSE, sep = ",")

hepatitis <- hepatitis_raw

names <- c("Class", "Age", "Sex", "Steroid",  "Antivirals", "Fatigue", "Malaise", "Anorexia", "Liver_big", "Liver_firm",  "Spleen_palpable",  "Spiders", "Ascites",  "Varices", "Bilirubin", "Alk_phosphate", "Sgot",  "Albumin", "Protime",  "Histology")

names(hepatitis) <- names

head(hepatitis)
```


It looks like missing values are recorded as "?" in this dataset. Start by changing these to NA.

```{r}
library(naniar)
hepatitis <- hepatitis %>% 
  replace_with_na_all(condition = ~.x == "?")

sapply(hepatitis, function(x) sum(is.na(x))) # Display total NAs in each variable
```

Replace values of 1 and 2 with die and live, respectively (got this info from hepatitis NAMES file).

```{r}
hepatitis <- within(hepatitis, {
Class[Class == 1] <- "die"
Class[Class == 2] <- "live"
})
head(hepatitis, 10)

```

Use Hmisc for multiple  imputation. Start with aregimpute, which performs multiple imputation using bootstraping and predictive mean matching. This is good for continuous and categorical variables.


```{r}
library(Hmisc)
hepatitis_imp <- aregImpute(~ Steroid + Fatigue + Malaise + Anorexia + Liver_big + Liver_firm + Spleen_palpable + Spiders + Ascites + Varices + Bilirubin + Alk_phosphate + Sgot + Albumin + Protime, data = hepatitis, n.impute = 5)

```
Got an error message. Try transcan instead and follow the pipeline from Harrel Chapter 11.

```{r}
htrans <- #creates a transcan object with results of transcan imputation
  transcan(~ Steroid + Fatigue + Malaise + Anorexia + Liver_big + Liver_firm + 
             Spleen_palpable + Spiders + Ascites + Varices + Bilirubin + 
             Alk_phosphate + Sgot + Albumin + Protime,
           imputed=TRUE, transformed=TRUE, 
           data=hepatitis, pl=FALSE, pr=FALSE)

#impute creates a new data set with all values of imputed variables (designated with *)
hep_imp <- impute(htrans, data=hepatitis, list.out=TRUE)

```

Next add imputed values back to original data set.
```{r}

#all.vars returns a character vector containing all names in the expression. It seems this would be the
#same as making a vector like c("Steroid", "Fatigue", ...). all.vars() is a little more streamlined
#because you don't have to type quotes.
NAvars <- all.vars(~ Steroid + Fatigue + Malaise + Anorexia + Liver_big + Liver_firm + Spleen_palpable + Spiders + Ascites + Varices + Bilirubin + Alk_phosphate + Sgot + Albumin + Protime) 

for(x in NAvars) hepatitis[[x]] <- hep_imp[[x]] #assign imputed values in imp back to original dataset

sapply(hepatitis, function(x) sum(is.na(x))) #check that all NAs have been replaced

```

```{r}
glm.fit <- glm(Class ~ Age + Sex + Steroid + Antivirals + Fatigue + Malaise + Anorexia + Liver_big + Liver_firm + Spleen_palpable + Spiders + Ascites + Varices + Bilirubin + Alk_phosphate + Sgot + Albumin + Protime + Histology, data = hepatitis, family = binomial)
```

Need to change variable formats. 

```{r}
#Convert character variables to factors
hepatitis$Class <- as.factor(hepatitis$Class)
hepatitis$Steroid <- as.factor(hepatitis$Steroid) #After this Steroid still shows as class S3:impute
hepatitis$Antivirals <- as.factor(hepatitis$Antivirals)
hepatitis$Sex <- as.factor(hepatitis$Sex)
hepatitis$Histology <- as.factor(hepatitis$Histology)

#Convert factor variables to character and then to doubles
hepatitis$Albumin <- as.numeric(as.character(hepatitis$Albumin))
hepatitis$Bilirubin <- as.numeric(as.character(hepatitis$Bilirubin))
hepatitis$Alk_phosphate <- as.numeric(as.character(hepatitis$Alk_phosphate))
hepatitis$Sgot <- as.numeric(as.character(hepatitis$Sgot))
hepatitis$Protime <- as.numeric(as.character(hepatitis$Protime))

head(hepatitis)
#'*Sgot, Alk_phosphate, and Protime show as double - is this okay? Should they be numeric?*
```

```{r}
#'*Steroid is object of class impute and factor. Is this okay?*
class(hepatitis$Steroid)
```

Now that variables are in correct format, try glm() again.
```{r}
glm.fit <- glm(Class ~ Age + Sex + Steroid + Antivirals + Fatigue + Malaise + Anorexia + Liver_big + Liver_firm + Spleen_palpable + Spiders + Ascites + Varices + Bilirubin + Alk_phosphate + Sgot + Albumin + Protime + Histology, data = hepatitis, family = binomial)

summary(glm.fit)
```

```{r}
glm.probs <- predict(glm.fit,type = "response")
glm.probs[1:5]
```

```{r}
#not sure if die and live are in the right order here
glm.pred <- ifelse(glm.probs > 0.5, "die", "live")

attach(hepatitis) ## this returned an error message
table(glm.pred,Class)
```

```{r}
mean(glm.pred == Class)
```

I think this means the model was only correct 10% of the time. Need to check this model again, and fit some others as well!